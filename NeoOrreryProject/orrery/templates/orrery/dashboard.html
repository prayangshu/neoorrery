{% extends 'orrery/base.html' %}

{% block title %}NeoOrrery Dashboard{% endblock %}

{% block content %}
    <!-- Hidden fields to store data for JavaScript -->
    <span id="totalPlanets" style="display:none;">{{ total_planets }}</span>
    <span id="totalAsteroids" style="display:none;">{{ total_asteroids }}</span>
    <span id="totalPHA" style="display:none;">{{ total_pha }}</span>
    <span id="totalComets" style="display:none;">{{ total_comets }}</span>

    <!-- Greeting -->
    <div class="greeting">
        <h3>Good Morning, {{ user.first_name }}</h3>
        {% if not user.is_authenticated %}
            <a href="{% url 'signup' %}" class="btn btn-primary">Create Account</a>
        {% else %}
            <!-- Close Approaches Alert Subscription Form -->
            <form action="{% url 'toggle_alert_subscription' %}" method="POST">
                {% csrf_token %}
                <button type="submit" class="btn btn-info">
                    {% if user.userprofile.is_opted_in %}
                        Unsubscribe from Close Approaches Alert
                    {% else %}
                        Get Close Approaches Alert
                    {% endif %}
                </button>
            </form>

            <!-- Email Close Approaches Alert -->
            <form action="{% url 'email_close_approaches' %}" method="POST" style="margin-top: 10px;">
                {% csrf_token %}
                <button type="submit" class="btn btn-info">Email Close Approaches Alert!</button>
            </form>

            <!-- Fetch Real-Time Close Approaches -->
            <form action="{% url 'fetch_real_time_close_approaches' %}" method="POST" style="margin-top: 10px;">
                {% csrf_token %}
                <button type="submit" class="btn btn-warning">Update Real-Time Close Approaches</button>
            </form>

            <!-- Logout Form -->
            <form action="{% url 'logout' %}" method="POST" style="margin-top: 10px;">
                {% csrf_token %}
                <button type="submit" class="btn btn-danger">Logout</button>
            </form>
        {% endif %}
    </div>

    <!-- Dashboard Cards -->
    <div class="dashboard-cards">
        <div class="card">
            <h4>Total Celestial Bodies</h4>
            <h2>{{ total_celestial_bodies }}</h2>
            {% if total_celestial_bodies_change %}
                <p class="{% if total_celestial_bodies_change > 0 %}up{% else %}down{% endif %}">
                    {{ total_celestial_bodies_change }}%
                </p>
            {% endif %}
        </div>
        <div class="card">
            <h4>Planets</h4>
            <h2>{{ total_planets }}</h2>
            {% if planets_change %}
                <p class="{% if planets_change > 0 %}up{% else %}down{% endif %}">
                    {{ planets_change }}%
                </p>
            {% endif %}
        </div>
        <div class="card">
            <h4>Asteroids</h4>
            <h2>{{ total_asteroids }}</h2>
            {% if asteroids_change %}
                <p class="{% if asteroids_change > 0 %}up{% else %}down{% endif %}">
                    {{ asteroids_change }}%
                </p>
            {% endif %}
        </div>
        <div class="card">
            <h4>Potentially Hazardous Asteroids (PHA)</h4>
            <h2>{{ total_pha }}</h2>
            {% if pha_change %}
                <p class="{% if pha_change > 0 %}up{% else %}down{% endif %}">
                    {{ pha_change }}%
                </p>
            {% endif %}
        </div>
        <div class="card">
            <h4>Comets</h4>
            <h2>{{ total_comets }}</h2>
            {% if comets_change %}
                <p class="{% if comets_change > 0 %}up{% else %}down{% endif %}">
                    {{ comets_change }}%
                </p>
            {% endif %}
        </div>
    </div>

    <!-- Real-Time Close Approaches Section -->
    <div class="close-approaches-section">
        <h3>Real-Time Close Approaches</h3>
        <table class="close-approaches-table">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Distance (km)</th>
                    <th>Velocity (km/h)</th>
                    <th>Approach Date</th>
                </tr>
            </thead>
            <tbody>
                {% for approach in close_approaches %}
                <tr>
                    <td>{{ approach.name }}</td>
                    <td>{{ approach.distance|floatformat:0 }}</td>
                    <td>{{ approach.velocity|floatformat:0 }}</td>
                    <td>{{ approach.approach_date }}</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="4">No close approaches found</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Critical Close Approaches Section -->
    <div class="critical-approaches-section">
        <h3>Critical Close Approaches</h3>
        <table class="critical-approaches-table">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Distance (km)</th>
                    <th>Velocity (km/h)</th>
                    <th>Approach Date</th>
                </tr>
            </thead>
            <tbody>
                {% for approach in critical_approaches %}
                <tr>
                    <td>{{ approach.name }}</td>
                    <td>{{ approach.distance|floatformat:0 }}</td>
                    <td>{{ approach.velocity|floatformat:0 }}</td>
                    <td>{{ approach.approach_date }}</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="4">No critical close approaches found</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Pie Chart and Details Section -->
    <div class="graph-container">
        <div class="chart-section">
            <canvas id="celestial-body-chart"></canvas>
        </div>
        <div class="details-section">
            <div>Planets: <span id="planets-percentage"></span></div>
            <div>Asteroids: <span id="asteroids-percentage"></span></div>
            <div>PHA: <span id="pha-percentage"></span></div>
            <div>Comets: <span id="comets-percentage"></span></div>
        </div>
    </div>

    <!-- NASA Eyes on Asteroids Iframe Section -->
    <div class="iframe-container">
        <iframe src="https://eyes.nasa.gov/apps/asteroids/#/home" title="NASA Eyes on Asteroids" style="border: none;"></iframe>
    </div>

    <!-- Table Section -->
    <table class="celestial-table">
        <thead>
            <tr>
                <th>Name</th>
                <th>Body Type</th>
                <th>Size (meters)</th>
                <th>Distance from Earth (km)</th>
                <th>Last Updated</th>
            </tr>
        </thead>
        <tbody>
            {% for body in celestial_bodies %}
            <tr>
                <td><a href="{% url 'body_detail' body.pk body.get_body_type %}">{{ body.name }}</a></td>
                <td>{{ body.get_body_type }}</td>
                <td>{{ body.size|default:"N/A" }}</td>
                <td>{{ body.distance|default:"N/A" }}</td>
                <td>{{ body.last_updated|date:"Y-m-d" }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
{% endblock %}
